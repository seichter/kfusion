cmake_minimum_required(VERSION 2.8)

project(kfusion)

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/cmake)

find_package(CUDA REQUIRED)
find_package(TooN REQUIRED)
find_package(OpenGL)
find_package(Freenect)
find_package(OpenNI2)
#find_package(LibRealSense)
find_package(GLUT)


set(CMAKE_CXX_STANDARD 11)


# require gcc 5 on Linux
set(CUDA_HOST_COMPILER /usr/bin/gcc-5)

include_directories(
    ${CMAKE_BINARY_DIR}/include
    ${TOON_INCLUDE_PATHS}
    )


add_subdirectory(thirdparty/librealsense)

#cuda_add_executable(devicequery
#        devicequery.cpp
#        )

#target_link_libraries(devicequery
#    ${CUDA_LIBRARIES}
#    )


#message(STATUS "${CUDA_LIBRARIES}")

find_package(Threads REQUIRED)

set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -std=c11 ")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11")

set(kfusion_cuda_srcs
    helpers.cu
    helpers.h
    kfusion.cu
    kfusion.h
    cutil_math.h
    README.md
    )

cuda_add_library(kfusion STATIC
    ${kfusion_cuda_srcs}
    perfstats.h
    OPTIONS
    -O3
    )

if (GLUT_FOUND)

    include_directories(${GLUT_INCLUDE_DIR})

    add_executable(kfusion_test
        test.cpp
        )

    target_link_libraries(kfusion_test kfusion ${GLUT_LIBRARIES} ${OPENGL_LIBRARIES} ${CMAKE_THREAD_LIBS_INIT})

    if(FREENECT_FOUND)
        include_directories(${FREENECT_INCLUDE_PATHS})
        add_definitions(-DLIBFREENECT_INTERFACE)
        add_executable(kfusion_kinect
            kinect.cpp
            interface.h
            interface.cpp
            interface_kinect.hpp
            interface_kinect.cpp
            interface_librealsense.hpp
            interface_librealsense.cpp
            interface_openni2.hpp
            interface_openni2.cpp
            )

        target_link_libraries(kfusion_kinect
            kfusion
            ${GLUT_LIBRARIES}
            ${OPENGL_LIBRARIES}
            ${FREENECT_LIBRARIES}
            realsense
            ${CMAKE_THREAD_LIBS_INIT}
            ${OPENNI2_LIBRARY}
            )


        install(TARGETS kfusion_kinect kfusion_test
            RUNTIME DESTINATION bin
            LIBRARY DESTINATION bin
            )


    else()

        include_directories($ENV{KINECTSDK10_DIR}/inc)
        add_definitions(-DMS_KINECT_INTERFACE)
        add_executable(kfusion_kinect
            kinect.cpp interface.h interface.cpp
            )
        target_link_libraries(kfusion_kinect kfusion ${GLUT_LIBRARIES} ${OPENGL_LIBRARIES} $ENV{KINECTSDK10_DIR}/lib/amd64/Kinect10.lib)
    endif()

endif()
